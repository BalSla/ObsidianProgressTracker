/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var Y=Object.create;var H=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var ee=Object.getOwnPropertyNames;var te=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var ne=(o,s)=>{for(var e in s)H(o,e,{get:s[e],enumerable:!0})},z=(o,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of ee(s))!se.call(o,n)&&n!==e&&H(o,n,{get:()=>s[n],enumerable:!(t=Z(s,n))||t.enumerable});return o};var O=(o,s,e)=>(e=o!=null?Y(te(o)):{},z(s||!o||!o.__esModule?H(e,"default",{value:o,enumerable:!0}):e,o)),ie=o=>z(H({},"__esModule",{value:!0}),o);var re={};ne(re,{default:()=>_});module.exports=ie(re);var C=require("obsidian"),M=O(require("path")),J=require("obsidian"),K=require("@codemirror/state"),W=require("@codemirror/view");var A=O(require("fs")),w=O(require("path"));var R=class{constructor(s){this.hasCycle=!1;this.rootNodes=s}processNode(s,e=new Set){if(e.has(s))return this.hasCycle=!0,{total:0,completed:0};if(e.add(s),!s.children||s.children.length===0){let t={total:1,completed:s.completed?1:0};return e.delete(s),t}else{let t=0,n=0;for(let i of s.children){let a=this.processNode(i,e);t+=a.total,n+=a.completed}return e.delete(s),{total:t,completed:n}}}getCounts(){this.hasCycle=!1;let s=0,e=0;for(let t of this.rootNodes){let n=this.processNode(t);s+=n.total,e+=n.completed}return{total:s,completed:e}}getCompletionString(){let s=this.getCounts(),e;return s.total===0?e="No tasks":e=`Complete ${Math.round(s.completed/s.total*100)}% (${s.completed}/${s.total})`,(this.hasMalformed()||this.hasCycle)&&(e+=" \u2757"),e}addSubtask(s,e){let t=this.findNode(s,this.rootNodes);if(!t)throw new Error("Parent task not found");t.children.push(e)}findNode(s,e){for(let t of e){if(t===s)return t;let n=this.findNode(s,t.children);if(n)return n}return null}hasMalformed(){let s=e=>{if(e.children&&e.children.length>0){let t=this.processNode(e);if(e.completed&&t.completed<t.total||!e.completed&&t.completed===t.total)return!0;for(let n of e.children)if(s(n))return!0}return!1};return this.rootNodes.some(s)}};function B(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function D(o,s){let e=/^---\s*\n([\s\S]*?)\n---/m.exec(o);if(e){let a=e[1];if(new RegExp(`(?:tags:\\s*\\[.*?\\b${B(s)}\\b.*?\\]|tags:\\s*${B(s)}\\b|tags:\\s*\\n\\s*-\\s*${B(s)}\\b)`,"i").test(a))return!0}let t=o;e&&(t=o.slice(e[0].length));let n=t.replace(/```[\s\S]*?```/g,"");return n=n.replace(/`[^`]*`/g,""),new RegExp(`#${B(s)}(?:\\s|$)`,"i").test(n)}var E=class{constructor(s,e="ignoretasktree"){this.cache=new Set;this.fileStack=[];this.hasFileCycle=!1;this.rootDir=w.resolve(s||process.cwd()),this.ignoreTag=e}isPathInsideRoot(s){let e=w.relative(this.rootDir,s);return!e.startsWith("..")&&!w.isAbsolute(e)}shouldIgnoreFile(s){let e=w.isAbsolute(s)?s:w.resolve(this.rootDir,s);if(!this.isPathInsideRoot(e)||!A.existsSync(e))return!1;let t=A.readFileSync(e,"utf-8");return D(t,this.ignoreTag)}buildFromFile(s){let e=w.isAbsolute(s)?s:w.resolve(this.rootDir,s),t=w.normalize(e),n=w.relative(this.rootDir,t),i=n.startsWith("..")||w.isAbsolute(n),a=this.fileStack.length===0;if(a&&(this.cache.clear(),this.fileStack=[]),i){if(a)throw new Error(`File outside rootDir: ${t}`);return new R([])}if(!A.existsSync(t)){if(a)throw new Error(`File not found: ${t}`);return new R([])}if(this.cache.has(t))return new R([]);this.cache.add(t),this.fileStack.push(t);let p=A.readFileSync(t,"utf-8");if(D(p,this.ignoreTag))return this.fileStack.pop(),new R([]);let r=p.split(/\r?\n/),l=this.parseLines(r,w.dirname(t));return this.fileStack.pop(),new R(l)}parseLines(s,e){let t=[],n=[{indent:-1,children:t}],i=new Set;for(let a of s){let p=/^(\s*)- \[( |x|X)\] (.+)$/.exec(a);if(p){let r=p[1].length,l=p[2].toLowerCase()==="x",f=p[3],c={completed:l,children:[]},k=/\[\[([^\]]+)\]\]/.exec(f);if(k){let u=k[1].split("|")[0].trim(),h=u.toLowerCase().endsWith(".md")?u:`${u}.md`,g=w.resolve(e,h);if(this.isPathInsideRoot(g)&&A.existsSync(g))if(this.fileStack.includes(g))c.children=[];else if(i.has(g))c.children=[];else{i.add(g);let m=this.buildFromFile(g);c.children=m.rootNodes||[]}}for(;n.length>0&&r<=n[n.length-1].indent;)n.pop();n[n.length-1].children.push(c),n.push({indent:r,children:c.children})}else{let r=/^(\s*)- (.+)$/.exec(a);if(r){let l=r[1].length,f=r[2];for(;n.length>0&&l<=n[n.length-1].indent;)n.pop();let c=/\[\[([^\]]+)\]\]/.exec(f);if(c){let d=c[1].split("|")[0].trim(),u=d.toLowerCase().endsWith(".md")?d:`${d}.md`,h=w.resolve(e,u);if(this.isPathInsideRoot(h)&&A.existsSync(h))if(!this.fileStack.includes(h)&&!i.has(h)){i.add(h);let m=this.buildFromFile(h).rootNodes||[];for(let P of m)n[n.length-1].children.push(P)}else this.fileStack.includes(h)&&(this.hasFileCycle=!0)}n.push({indent:l,children:n[n.length-1].children})}}}return t}};var X=O(require("fs")),I=O(require("path"));function U(o,s,e){let t=[],n=[{indent:-1,task:void 0}];for(let i=0;i<o.length;i++){let a=/^(\s*)- \[( |x|X)\](.*)$/.exec(o[i]);if(a){let r=a[1].length,l=a[2].toLowerCase()==="x",f=a[3]||"",c={line:i,indent:r,completed:l,children:[]};if(e&&s){let d=/\[\[([^\]]+)\]\]/g,u=f.matchAll(d),h=!1,g=!0,m=!1,P=!1;for(let y of u){h=!0;let S=y[1].split("|")[0].trim(),v=S.toLowerCase().endsWith(".md")?S:`${S}.md`,T=I.resolve(s,v);if(X.existsSync(T)){if(e.shouldIgnoreFile(T))continue;try{let x=e.buildFromFile(T).getCounts();x.total!==0&&(m=!0,x.total>0&&x.total===x.completed||(g=!1,P=!0))}catch(b){}}}h&&(m?g&&!P?c.linkChildrenComplete=!0:P&&(c.linkChildrenComplete=!1):c.linkChildrenComplete=void 0)}else if(s){let d=/\[\[([^\]]+)\]\]/g,u=f.matchAll(d),h=!1,g=!0,m=!1,P=!1;for(let y of u){h=!0;let S=y[1].split("|")[0].trim(),v=S.toLowerCase().endsWith(".md")?S:`${S}.md`,T=I.resolve(s,v);if(X.existsSync(T))try{let x=X.readFileSync(T,"utf8").split(/\r?\n/),F=0,L=0;for(let $ of x){let V=/^\s*- \[( |x|X)\]/.exec($);V&&(F++,V[1].toLowerCase()==="x"&&L++)}F!==0&&(m=!0,L!==F&&(g=!1,P=!0))}catch(b){}}h&&(m?g&&!P?c.linkChildrenComplete=!0:P&&(c.linkChildrenComplete=!1):c.linkChildrenComplete=void 0)}for(;n.length>0&&r<=n[n.length-1].indent;)n.pop();let k=n[n.length-1].task;k&&(c.parent=k,k.children.push(c)),t.push(c),n.push({indent:r,task:c});continue}let p=/^(\s*)-\s(?!\[( |x|X)\])(.*)$/.exec(o[i]);if(p){let r=p[1].length;for(;n.length>0&&r<=n[n.length-1].indent;)n.pop();n.push({indent:r,task:void 0});continue}}return t}function G(o,s,e,t,n="ignoretasktree",i=!0){var k;if(!i){let d=o.split(/\r?\n/),u=U(d),h=new Map;for(let g of u)h.set(g.line,g.completed);return{content:o,state:h}}let a=o.split(/\r?\n/),p,r;e&&t&&(r=I.dirname(I.isAbsolute(e)?e:I.resolve(t,e)),p=new E(t,n));let l=U(a,r,p),f=l.slice().sort((d,u)=>u.indent-d.indent);for(let d of f){if(d.children.length===0&&d.linkChildrenComplete===void 0)continue;let u=d.children.every(m=>m.completed),h=(k=d.linkChildrenComplete)!=null?k:!0,g=u&&h;d.completed!==g&&(a[d.line]=a[d.line].replace(/^(\s*- \[)( |x|X)(\])/,`$1${g?"x":" "}$3`),d.completed=g)}let c=new Map;for(let d of l)c.set(d.line,d.completed);return{content:a.join(`
`),state:c}}var ae={mySetting:"default",inlineFieldName:"COMPLETE",representation:"Complete {percentage}% ({completed}/{total})",ignoreTag:"ignoretasktree",autoPropagateTaskStates:!0};function j(o,s){let e=M.resolve(o,s),t=M.relative(o,e);if(t.startsWith("..")||M.isAbsolute(t)){console.warn(`Skipping invalid path outside vault: ${s}`);return}return e}var _=class extends C.Plugin{constructor(){super(...arguments);this.fileStates=new Map;this.skipModify=!1;this.pageTasksCache=null;this.lastOpenedFilePath=null}async onload(){await this.loadSettings(),this.addSettingTab(new q(this.app,this)),this.registerMarkdownPostProcessor((t,n)=>{let i="",a=this.app.vault.adapter;i=typeof a.getBasePath=="function"?a.getBasePath():"";let p=new E(i,this.settings.ignoreTag),r=this.settings.inlineFieldName,l=this.settings.representation;t.querySelectorAll("p").forEach(f=>{var h;let c=new RegExp(`${B(r)}:\\[\\[([^\\]]*)\\]\\]`,"g"),k=document.createTreeWalker(f,NodeFilter.SHOW_TEXT),d=[],u;for(;u=k.nextNode();){let g=u.nodeValue||"";c.lastIndex=0;let m,P=0,y=document.createDocumentFragment();for(;m=c.exec(g);){let S=g.slice(P,m.index);S&&y.append(S);let v=m[1],T;if(v&&v.trim()!==""){let L=n.sourcePath?n.sourcePath.replace(/\/[^/]+$/,""):"",$=v.endsWith(".md")?v:`${v}.md`;T=L?`${L}/${$}`:$}else T=(h=n.sourcePath)!=null?h:"";let b=j(i,T),x;try{if(!b)throw new Error("invalid");let L=p.buildFromFile(b),$=L.getCounts(),V=L.getCompletionString();if($.total===0)x=V;else{let Q=Math.round($.completed/$.total*100);x=l.replace("{completed}",`${$.completed}`).replace("{total}",`${$.total}`).replace("{percentage}",`${Q}`),V.endsWith(" \u2757")&&(x+=" \u2757")}}catch(L){x="No tasks"}let F=document.createElement("span");F.addClass("completed-task-reading"),F.setText(x),y.append(F),P=m.index+m[0].length}if(P===0)continue;let N=g.slice(P);N&&y.append(N),d.push({node:u,frag:y})}for(let{node:g,frag:m}of d)g.replaceWith(m)})}),this.registerEditorExtension(this.createLivePreviewExtension()),this.registerEvent(this.app.vault.on("modify",t=>this.handleFileModify(t))),this.registerEvent(this.app.workspace.on("file-open",t=>this.handleFileOpen(t))),this.registerEvent(this.app.vault.on("delete",t=>this.handleFileDelete(t)));let e=this.app.workspace.getActiveFile();e&&await this.handleFileOpen(e)}handleFileDelete(e){this.pageTasksCache=null}async handleFileOpen(e){if(!e)return;let t="",n=this.app.vault.adapter;t=typeof n.getBasePath=="function"?n.getBasePath():"";let i=j(t,e.path);if(i){try{let a=await this.app.vault.read(e);if(D(a,this.settings.ignoreTag))return;let p=a.split(/\r?\n/),r=M.dirname(i),l=new E(t,this.settings.ignoreTag),f=U(p,r,l);if(!f||f.length===0)return;this.pageTasksCache=f}catch(a){console.error("[ProgressTracker] Failed to parse tasks for file",e.path,a)}this.lastOpenedFilePath=e?e.path:null}}createLivePreviewExtension(){let e=this;class t extends W.WidgetType{constructor(p){super();this.displayText=p}toDOM(){let p=document.createElement("span");return p.className="cm-completed-task-widget",p.textContent=`[${this.displayText}]`,p}ignoreEvent(){return!1}}return W.ViewPlugin.fromClass(class{constructor(i){this.regex=new RegExp(`${B(e.settings.inlineFieldName)}:\\[\\[([^\\]]*)\\]\\]`,"g"),this.decorations=this.buildDecorations(i)}update(i){(i.docChanged||i.viewportChanged||i.selectionSet)&&(this.decorations=this.buildDecorations(i.view))}buildDecorations(i){let a=new K.RangeSetBuilder,p=i.state.field(J.editorLivePreviewField);if(!p)return a.finish();let r=p.sourcePath,l="",f=e.app.vault.adapter;l=typeof f.getBasePath=="function"?f.getBasePath():"";let c=new E(l,e.settings.ignoreTag);for(let{from:k,to:d}of i.visibleRanges){let u=i.state.doc.sliceString(k,d),h;for(;h=this.regex.exec(u);){let g=k+h.index,m=h[0].length,P=i.state.selection.main.head;if(P>=g&&P<=g+m)continue;let y,N=h[1];if(N&&N.trim()!==""){let T=r?r.replace(/\/[^/]+$/,""):"",b=N.endsWith(".md")?N:`${N}.md`;y=T?`${T}/${b}`:b}else if(r)y=r;else{let T=e.app.workspace.getActiveFile();y=(T==null?void 0:T.path)||""}let S=j(l,y),v;try{if(!S)throw new Error("invalid");let T=c.buildFromFile(S),b=T.getCounts(),x=T.getCompletionString();if(b.total===0)v=x;else{let F=Math.round(b.completed/b.total*100);v=e.settings.representation.replace("{completed}",`${b.completed}`).replace("{total}",`${b.total}`).replace("{percentage}",`${F}`),x.endsWith(" \u2757")&&(v+=" \u2757")}}catch(T){v="No tasks"}a.add(g,g+m,W.Decoration.replace({widget:new t(v)}))}}return a.finish()}},{decorations:i=>i.decorations})}onunload(){}async loadSettings(){this.settings=Object.assign({},ae,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async handleFileModify(e){var p;if(this.skipModify){this.skipModify=!1;return}let t=e.path,n="",i=this.app.vault.adapter;n=typeof i.getBasePath=="function"?i.getBasePath():"";try{let r=await this.app.vault.read(e);if(D(r,this.settings.ignoreTag))return;let l=r.split(/\r?\n/),f=M.dirname((p=j(n,t))!=null?p:""),c=new E(n,this.settings.ignoreTag),k=U(l,f,c);if(!k||k.length===0)return;let d=this.pageTasksCache;if(this.lastOpenedFilePath===t&&d&&d.length===k.length&&d.every((u,h)=>u.line===k[h].line&&u.completed===k[h].completed))return}catch(r){console.error("[ProgressTracker] Error comparing cache for file",t,r)}let a=new Set;await this.updateFileAndBacklinks(t,a,n)}async updateFileAndBacklinks(e,t,n){var r;if(t.has(e))return;t.add(e);let i=this.app.vault.getAbstractFileByPath(e);if(!(i instanceof C.TFile))return;try{let l=await this.app.vault.read(i),f=this.fileStates.get(e),c=G(l,f,e,n,this.settings.ignoreTag,this.settings.autoPropagateTaskStates);this.fileStates.set(e,c.state),c.content!==l&&(this.skipModify=!0,await this.app.vault.modify(i,c.content))}catch(l){console.error(l)}let a=this.app.workspace.getLeavesOfType("markdown");for(let l of a)l.view instanceof C.MarkdownView&&((r=l.view.file)==null?void 0:r.path)===e&&l.view.previewMode.rerender(!0);let p=oe(this.app,e);for(let l of p)await this.updateFileAndBacklinks(l,t,n)}getPageProgress(e){let t="",n=this.app.vault.adapter;t=typeof n.getBasePath=="function"?n.getBasePath():"";let i=typeof e=="string"?e:e.path,a=j(t,i);if(!a)throw new Error(`Invalid path: ${i}`);let l=new E(t,this.settings.ignoreTag).buildFromFile(a).getCounts();return l.total===0?0:Math.round(l.completed/l.total*100)}};function oe(o,s){let e=o.metadataCache.resolvedLinks,t=[];for(let[n,i]of Object.entries(e))typeof i=="object"&&i!==null&&i[s]&&t.push(n);return t}var q=class extends C.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;s.empty(),new C.Setting(s).setName("Inline Field Name").setDesc("The name of the inline field tag (e.g., COMPLETE)").addText(e=>e.setPlaceholder("Enter inline field name").setValue(this.plugin.settings.inlineFieldName).onChange(async t=>{this.plugin.settings.inlineFieldName=t,await this.plugin.saveSettings()})),new C.Setting(s).setName("Representation Template").setDesc("Template for display using {completed}, {total}, and {percentage}").addText(e=>e.setPlaceholder("e.g., Complete {percentage}% ({completed}/{total})").setValue(this.plugin.settings.representation).onChange(async t=>{this.plugin.settings.representation=t,await this.plugin.saveSettings()})),new C.Setting(s).setName("Ignore Tag").setDesc("Tag to ignore pages (without #), e.g., ignoretasktree").addText(e=>e.setPlaceholder("Enter ignore tag").setValue(this.plugin.settings.ignoreTag).onChange(async t=>{this.plugin.settings.ignoreTag=t,await this.plugin.saveSettings()})),new C.Setting(s).setName("Auto Propagate Task States").setDesc("Automatically check/uncheck parent tasks when all children change state").addToggle(e=>e.setValue(this.plugin.settings.autoPropagateTaskStates).onChange(async t=>{this.plugin.settings.autoPropagateTaskStates=t,await this.plugin.saveSettings()}))}};
