/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var Y=Object.create;var X=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var ee=Object.getOwnPropertyNames;var te=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var ne=(r,s)=>{for(var e in s)X(r,e,{get:s[e],enumerable:!0})},z=(r,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of ee(s))!se.call(r,n)&&n!==e&&X(r,n,{get:()=>s[n],enumerable:!(t=Z(s,n))||t.enumerable});return r};var W=(r,s,e)=>(e=r!=null?Y(te(r)):{},z(s||!r||!r.__esModule?X(e,"default",{value:r,enumerable:!0}):e,r)),ie=r=>z(X({},"__esModule",{value:!0}),r);var re={};ne(re,{default:()=>j});module.exports=ie(re);var S=require("obsidian"),M=W(require("path")),J=require("obsidian"),K=require("@codemirror/state"),D=require("@codemirror/view");var R=W(require("fs")),w=W(require("path"));var I=class{constructor(s){this.hasCycle=!1;this.rootNodes=s}processNode(s,e=new Set){if(e.has(s))return this.hasCycle=!0,{total:0,completed:0};if(e.add(s),!s.children||s.children.length===0){let t={total:1,completed:s.completed?1:0};return e.delete(s),t}else{let t=0,n=0;for(let i of s.children){let o=this.processNode(i,e);t+=o.total,n+=o.completed}return e.delete(s),{total:t,completed:n}}}getCounts(){this.hasCycle=!1;let s=0,e=0;for(let t of this.rootNodes){let n=this.processNode(t);s+=n.total,e+=n.completed}return{total:s,completed:e}}getCompletionString(){let s=this.getCounts(),e;return s.total===0?e="No tasks":e=`Complete ${Math.round(s.completed/s.total*100)}% (${s.completed}/${s.total})`,(this.hasMalformed()||this.hasCycle)&&(e+=" \u2757"),e}addSubtask(s,e){let t=this.findNode(s,this.rootNodes);if(!t)throw new Error("Parent task not found");t.children.push(e)}findNode(s,e){for(let t of e){if(t===s)return t;let n=this.findNode(s,t.children);if(n)return n}return null}hasMalformed(){let s=e=>{if(e.children&&e.children.length>0){let t=this.processNode(e);if(e.completed&&t.completed<t.total||!e.completed&&t.completed===t.total)return!0;for(let n of e.children)if(s(n))return!0}return!1};return this.rootNodes.some(s)}};var U=class extends I{constructor(e,t){super(e);this.fileHasCycle=t}getCounts(){return this.fileHasCycle?{total:0,completed:0}:super.getCounts()}getCompletionString(){let e=super.getCompletionString();return this.fileHasCycle&&!e.endsWith(" \u2757")?e+" \u2757":e}},E=class{constructor(s,e="ignoretasktree"){this.cache=new Set;this.hasFileCycle=!1;this.fileStack=[];this.rootDir=w.resolve(s||process.cwd()),this.ignoreTag=e}isPathInsideRoot(s){let e=w.relative(this.rootDir,s);return!e.startsWith("..")&&!w.isAbsolute(e)}shouldIgnoreFile(s){let e=w.isAbsolute(s)?s:w.resolve(this.rootDir,s);return!this.isPathInsideRoot(e)||!R.existsSync(e)?!1:R.readFileSync(e,"utf-8").includes(`#${this.ignoreTag}`)}buildFromFile(s){let e=w.isAbsolute(s)?s:w.resolve(this.rootDir,s),t=w.normalize(e),n=w.relative(this.rootDir,t),i=n.startsWith("..")||w.isAbsolute(n),o=this.fileStack.length===0;if(o&&(this.cache.clear(),this.hasFileCycle=!1,this.fileStack=[]),i){if(o)throw new Error(`File outside rootDir: ${t}`);return new I([])}if(!R.existsSync(t)){if(o)throw new Error(`File not found: ${t}`);return new I([])}if(this.cache.has(t))return new I([]);this.cache.add(t),this.fileStack.push(t);let d=R.readFileSync(t,"utf-8");if(d.includes(`#${this.ignoreTag}`))return this.fileStack.pop(),new U([],!1);let l=d.split(/\r?\n/),a=this.parseLines(l,w.dirname(t));return this.fileStack.pop(),new U(a,o&&this.hasFileCycle)}parseLines(s,e){let t=[],n=[{indent:-1,children:t}];for(let i of s){let o=/^(\s*)- \[( |x|X)\] (.+)$/.exec(i);if(o){let d=o[1].length,l=o[2].toLowerCase()==="x",a=o[3],h={completed:l,children:[]},p=/\[\[([^\]]+)\]\]/.exec(a);if(p){let c=p[1].split("|")[0].trim(),f=c.toLowerCase().endsWith(".md")?c:`${c}.md`,u=w.resolve(e,f);if(this.isPathInsideRoot(u)&&R.existsSync(u))if(this.fileStack.includes(u))this.hasFileCycle=!0,h.children=[h];else{let g=this.buildFromFile(u);h.children=g.rootNodes||[]}}for(;n.length>0&&d<=n[n.length-1].indent;)n.pop();n[n.length-1].children.push(h),n.push({indent:d,children:h.children})}else{let d=/^(\s*)- (.+)$/.exec(i);if(d){let l=d[1].length,a=d[2];for(;n.length>0&&l<=n[n.length-1].indent;)n.pop();let h=/\[\[([^\]]+)\]\]/.exec(a);if(h){let m=h[1].split("|")[0].trim(),c=m.toLowerCase().endsWith(".md")?m:`${m}.md`,f=w.resolve(e,c);if(this.isPathInsideRoot(f)&&R.existsSync(f))if(this.fileStack.includes(f))this.hasFileCycle=!0;else{let g=this.buildFromFile(f).rootNodes||[];for(let T of g)n[n.length-1].children.push(T)}}n.push({indent:l,children:n[n.length-1].children})}}}return t}};var V=W(require("fs")),A=W(require("path"));function O(r,s,e){let t=[],n=[{indent:-1,task:void 0}];for(let i=0;i<r.length;i++){let o=/^(\s*)- \[( |x|X)\](.*)$/.exec(r[i]);if(o){let l=o[1].length,a=o[2].toLowerCase()==="x",h=o[3]||"",p={line:i,indent:l,completed:a,children:[]};if(e&&s){let c=/\[\[([^\]]+)\]\]/g,f=h.matchAll(c),u=!1,g=!0,T=!1,P=!1;for(let C of f){u=!0;let x=C[1].split("|")[0].trim(),v=x.toLowerCase().endsWith(".md")?x:`${x}.md`,k=A.resolve(s,v);if(V.existsSync(k)){if(e.shouldIgnoreFile(k))continue;try{let b=e.buildFromFile(k).getCounts();b.total!==0&&(T=!0,b.total>0&&b.total===b.completed||(g=!1,P=!0))}catch(y){}}}u&&(T?g&&!P?p.linkChildrenComplete=!0:P&&(p.linkChildrenComplete=!1):p.linkChildrenComplete=void 0)}else if(s){let c=/\[\[([^\]]+)\]\]/g,f=h.matchAll(c),u=!1,g=!0,T=!1,P=!1;for(let C of f){u=!0;let x=C[1].split("|")[0].trim(),v=x.toLowerCase().endsWith(".md")?x:`${x}.md`,k=A.resolve(s,v);if(V.existsSync(k))try{let b=V.readFileSync(k,"utf8").split(/\r?\n/),F=0,L=0;for(let $ of b){let B=/^\s*- \[( |x|X)\]/.exec($);B&&(F++,B[1].toLowerCase()==="x"&&L++)}F!==0&&(T=!0,L!==F&&(g=!1,P=!0))}catch(y){}}u&&(T?g&&!P?p.linkChildrenComplete=!0:P&&(p.linkChildrenComplete=!1):p.linkChildrenComplete=void 0)}for(;n.length>0&&l<=n[n.length-1].indent;)n.pop();let m=n[n.length-1].task;m&&(p.parent=m,m.children.push(p)),t.push(p),n.push({indent:l,task:p});continue}let d=/^(\s*)-\s(?!\[( |x|X)\])(.*)$/.exec(r[i]);if(d){let l=d[1].length;for(;n.length>0&&l<=n[n.length-1].indent;)n.pop();n.push({indent:l,task:void 0});continue}}return t}function G(r,s,e,t,n="ignoretasktree",i=!0){var m;if(!i){let c=r.split(/\r?\n/),f=O(c),u=new Map;for(let g of f)u.set(g.line,g.completed);return{content:r,state:u}}let o=r.split(/\r?\n/),d,l;e&&t&&(l=A.dirname(A.isAbsolute(e)?e:A.resolve(t,e)),d=new E(t,n));let a=O(o,l,d),h=a.slice().sort((c,f)=>f.indent-c.indent);for(let c of h){if(c.children.length===0&&c.linkChildrenComplete===void 0)continue;let f=c.children.every(T=>T.completed),u=(m=c.linkChildrenComplete)!=null?m:!0,g=f&&u;c.completed!==g&&(o[c.line]=o[c.line].replace(/^(\s*- \[)( |x|X)(\])/,`$1${g?"x":" "}$3`),c.completed=g)}let p=new Map;for(let c of a)p.set(c.line,c.completed);return{content:o.join(`
`),state:p}}function _(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var oe={mySetting:"default",inlineFieldName:"COMPLETE",representation:"Complete {percentage}% ({completed}/{total})",ignoreTag:"ignoretasktree",autoPropagateTaskStates:!0};function H(r,s){let e=M.resolve(r,s),t=M.relative(r,e);if(t.startsWith("..")||M.isAbsolute(t)){console.warn(`Skipping invalid path outside vault: ${s}`);return}return e}var j=class extends S.Plugin{constructor(){super(...arguments);this.fileStates=new Map;this.skipModify=!1;this.pageTasksCache=null;this.lastOpenedFilePath=null}async onload(){await this.loadSettings(),this.addSettingTab(new q(this.app,this)),this.registerMarkdownPostProcessor((t,n)=>{let i="",o=this.app.vault.adapter;i=typeof o.getBasePath=="function"?o.getBasePath():"";let d=new E(i,this.settings.ignoreTag),l=this.settings.inlineFieldName,a=this.settings.representation;t.querySelectorAll("p").forEach(h=>{var u;let p=new RegExp(`${_(l)}:\\[\\[([^\\]]*)\\]\\]`,"g"),m=document.createTreeWalker(h,NodeFilter.SHOW_TEXT),c=[],f;for(;f=m.nextNode();){let g=f.nodeValue||"";p.lastIndex=0;let T,P=0,C=document.createDocumentFragment();for(;T=p.exec(g);){let x=g.slice(P,T.index);x&&C.append(x);let v=T[1],k;if(v&&v.trim()!==""){let L=n.sourcePath?n.sourcePath.replace(/\/[^/]+$/,""):"",$=v.endsWith(".md")?v:`${v}.md`;k=L?`${L}/${$}`:$}else k=(u=n.sourcePath)!=null?u:"";let y=H(i,k),b;try{if(!y)throw new Error("invalid");let L=d.buildFromFile(y),$=L.getCounts(),B=L.getCompletionString();if($.total===0)b=B;else{let Q=Math.round($.completed/$.total*100);b=a.replace("{completed}",`${$.completed}`).replace("{total}",`${$.total}`).replace("{percentage}",`${Q}`),B.endsWith(" \u2757")&&(b+=" \u2757")}}catch(L){b="No tasks"}let F=document.createElement("span");F.addClass("completed-task-reading"),F.setText(b),C.append(F),P=T.index+T[0].length}if(P===0)continue;let N=g.slice(P);N&&C.append(N),c.push({node:f,frag:C})}for(let{node:g,frag:T}of c)g.replaceWith(T)})}),this.registerEditorExtension(this.createLivePreviewExtension()),this.registerEvent(this.app.vault.on("modify",t=>this.handleFileModify(t))),this.registerEvent(this.app.workspace.on("file-open",t=>this.handleFileOpen(t))),this.registerEvent(this.app.vault.on("delete",t=>this.handleFileDelete(t)));let e=this.app.workspace.getActiveFile();e&&await this.handleFileOpen(e)}handleFileDelete(e){this.pageTasksCache=null}async handleFileOpen(e){if(!e)return;let t="",n=this.app.vault.adapter;t=typeof n.getBasePath=="function"?n.getBasePath():"";let i=H(t,e.path);if(i){try{let o=await this.app.vault.read(e);if(o.match(new RegExp(`#${this.settings.ignoreTag}(s|$)`)))return;let d=o.split(/\r?\n/),l=M.dirname(i),a=new E(t,this.settings.ignoreTag),h=O(d,l,a);if(!h||h.length===0)return;this.pageTasksCache=h}catch(o){console.error("[ProgressTracker] Failed to parse tasks for file",e.path,o)}this.lastOpenedFilePath=e?e.path:null}}createLivePreviewExtension(){let e=this;class t extends D.WidgetType{constructor(d){super();this.displayText=d}toDOM(){let d=document.createElement("span");return d.className="cm-completed-task-widget",d.textContent=`[${this.displayText}]`,d}ignoreEvent(){return!1}}return D.ViewPlugin.fromClass(class{constructor(i){this.regex=new RegExp(`${_(e.settings.inlineFieldName)}:\\[\\[([^\\]]*)\\]\\]`,"g"),this.decorations=this.buildDecorations(i)}update(i){(i.docChanged||i.viewportChanged||i.selectionSet)&&(this.decorations=this.buildDecorations(i.view))}buildDecorations(i){let o=new K.RangeSetBuilder,d=i.state.field(J.editorLivePreviewField);if(!d)return o.finish();let l=d.sourcePath,a="",h=e.app.vault.adapter;a=typeof h.getBasePath=="function"?h.getBasePath():"";let p=new E(a,e.settings.ignoreTag);for(let{from:m,to:c}of i.visibleRanges){let f=i.state.doc.sliceString(m,c),u;for(;u=this.regex.exec(f);){let g=m+u.index,T=u[0].length,P=i.state.selection.main.head;if(P>=g&&P<=g+T)continue;let C,N=u[1];if(N&&N.trim()!==""){let k=l?l.replace(/\/[^/]+$/,""):"",y=N.endsWith(".md")?N:`${N}.md`;C=k?`${k}/${y}`:y}else if(l)C=l;else{let k=e.app.workspace.getActiveFile();C=(k==null?void 0:k.path)||""}let x=H(a,C),v;try{if(!x)throw new Error("invalid");let k=p.buildFromFile(x),y=k.getCounts(),b=k.getCompletionString();if(y.total===0)v=b;else{let F=Math.round(y.completed/y.total*100);v=e.settings.representation.replace("{completed}",`${y.completed}`).replace("{total}",`${y.total}`).replace("{percentage}",`${F}`),b.endsWith(" \u2757")&&(v+=" \u2757")}}catch(k){v="No tasks"}o.add(g,g+T,D.Decoration.replace({widget:new t(v)}))}}return o.finish()}},{decorations:i=>i.decorations})}onunload(){}async loadSettings(){this.settings=Object.assign({},oe,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async handleFileModify(e){var d;if(this.skipModify){this.skipModify=!1;return}let t=e.path,n="",i=this.app.vault.adapter;n=typeof i.getBasePath=="function"?i.getBasePath():"";try{let l=await this.app.vault.read(e);if(l.match(new RegExp(`#${this.settings.ignoreTag}(s|$)`)))return;let a=l.split(/\r?\n/),h=M.dirname((d=H(n,t))!=null?d:""),p=new E(n,this.settings.ignoreTag),m=O(a,h,p);if(!m||m.length===0)return;let c=this.pageTasksCache;if(this.lastOpenedFilePath===t&&c&&c.length===m.length&&c.every((f,u)=>f.line===m[u].line&&f.completed===m[u].completed))return}catch(l){console.error("[ProgressTracker] Error comparing cache for file",t,l)}let o=new Set;await this.updateFileAndBacklinks(t,o,n)}async updateFileAndBacklinks(e,t,n){var l;if(t.has(e))return;t.add(e);let i=this.app.vault.getAbstractFileByPath(e);if(!(i instanceof S.TFile))return;try{let a=await this.app.vault.read(i),h=this.fileStates.get(e),p=G(a,h,e,n,this.settings.ignoreTag,this.settings.autoPropagateTaskStates);this.fileStates.set(e,p.state),p.content!==a&&(this.skipModify=!0,await this.app.vault.modify(i,p.content))}catch(a){console.error(a)}let o=this.app.workspace.getLeavesOfType("markdown");for(let a of o)a.view instanceof S.MarkdownView&&((l=a.view.file)==null?void 0:l.path)===e&&a.view.previewMode.rerender(!0);let d=ae(this.app,e);for(let a of d)await this.updateFileAndBacklinks(a,t,n)}getPageProgress(e){let t="",n=this.app.vault.adapter;t=typeof n.getBasePath=="function"?n.getBasePath():"";let i=typeof e=="string"?e:e.path,o=H(t,i);if(!o)throw new Error(`Invalid path: ${i}`);let a=new E(t,this.settings.ignoreTag).buildFromFile(o).getCounts();return a.total===0?0:Math.round(a.completed/a.total*100)}};function ae(r,s){let e=r.metadataCache.resolvedLinks,t=[];for(let[n,i]of Object.entries(e))typeof i=="object"&&i!==null&&i[s]&&t.push(n);return t}var q=class extends S.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;s.empty(),new S.Setting(s).setName("Inline Field Name").setDesc("The name of the inline field tag (e.g., COMPLETE)").addText(e=>e.setPlaceholder("Enter inline field name").setValue(this.plugin.settings.inlineFieldName).onChange(async t=>{this.plugin.settings.inlineFieldName=t,await this.plugin.saveSettings()})),new S.Setting(s).setName("Representation Template").setDesc("Template for display using {completed}, {total}, and {percentage}").addText(e=>e.setPlaceholder("e.g., Complete {percentage}% ({completed}/{total})").setValue(this.plugin.settings.representation).onChange(async t=>{this.plugin.settings.representation=t,await this.plugin.saveSettings()})),new S.Setting(s).setName("Ignore Tag").setDesc("Tag to ignore pages (without #), e.g., ignoretasktree").addText(e=>e.setPlaceholder("Enter ignore tag").setValue(this.plugin.settings.ignoreTag).onChange(async t=>{this.plugin.settings.ignoreTag=t,await this.plugin.saveSettings()})),new S.Setting(s).setName("Auto Propagate Task States").setDesc("Automatically check/uncheck parent tasks when all children change state").addToggle(e=>e.setValue(this.plugin.settings.autoPropagateTaskStates).onChange(async t=>{this.plugin.settings.autoPropagateTaskStates=t,await this.plugin.saveSettings()}))}};
