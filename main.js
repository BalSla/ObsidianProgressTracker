/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var z=Object.create;var R=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var Q=(o,t)=>{for(var e in t)R(o,e,{get:t[e],enumerable:!0})},O=(o,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of _(t))!K.call(o,n)&&n!==e&&R(o,n,{get:()=>t[n],enumerable:!(s=G(t,n))||s.enumerable});return o};var L=(o,t,e)=>(e=o!=null?z(J(o)):{},O(t||!o||!o.__esModule?R(e,"default",{value:o,enumerable:!0}):e,o)),Y=o=>O(R({},"__esModule",{value:!0}),o);var se={};Q(se,{default:()=>D});module.exports=Y(se);var v=require("obsidian"),E=L(require("path")),j=require("obsidian"),X=require("@codemirror/state"),M=require("@codemirror/view");var F=L(require("fs")),f=L(require("path"));var N=class{constructor(t){this.hasCycle=!1;this.rootNodes=t}processNode(t,e=new Set){if(e.has(t))return this.hasCycle=!0,{total:0,completed:0};if(e.add(t),!t.children||t.children.length===0){let s={total:1,completed:t.completed?1:0};return e.delete(t),s}else{let s=0,n=0;for(let i of t.children){let r=this.processNode(i,e);s+=r.total,n+=r.completed}return e.delete(t),{total:s,completed:n}}}getCounts(){this.hasCycle=!1;let t=0,e=0;for(let s of this.rootNodes){let n=this.processNode(s);t+=n.total,e+=n.completed}return{total:t,completed:e}}getCompletionString(){let t=this.getCounts(),e;return t.total===0?e="No tasks":e=`Complete ${Math.round(t.completed/t.total*100)}% (${t.completed}/${t.total})`,(this.hasMalformed()||this.hasCycle)&&(e+=" \u2757"),e}addSubtask(t,e){let s=this.findNode(t,this.rootNodes);if(!s)throw new Error("Parent task not found");s.children.push(e)}findNode(t,e){for(let s of e){if(s===t)return s;let n=this.findNode(t,s.children);if(n)return n}return null}hasMalformed(){let t=e=>{if(e.children&&e.children.length>0){let s=this.processNode(e);if(e.completed&&s.completed<s.total||!e.completed&&s.completed===s.total)return!0;for(let n of e.children)if(t(n))return!0}return!1};return this.rootNodes.some(t)}};var A=class extends N{constructor(e,s){super(e);this.fileHasCycle=s}getCounts(){return this.fileHasCycle?{total:0,completed:0}:super.getCounts()}getCompletionString(){let e=super.getCompletionString();return this.fileHasCycle&&!e.endsWith(" \u2757")?e+" \u2757":e}},S=class{constructor(t,e="ignoretasktree"){this.cache=new Set;this.hasFileCycle=!1;this.fileStack=[];this.rootDir=f.resolve(t||process.cwd()),this.ignoreTag=e}isPathInsideRoot(t){let e=f.relative(this.rootDir,t);return!e.startsWith("..")&&!f.isAbsolute(e)}shouldIgnoreFile(t){let e=f.isAbsolute(t)?t:f.resolve(this.rootDir,t);return!this.isPathInsideRoot(e)||!F.existsSync(e)?!1:F.readFileSync(e,"utf-8").includes(`#${this.ignoreTag}`)}buildFromFile(t){let e=f.isAbsolute(t)?t:f.resolve(this.rootDir,t),s=f.normalize(e),n=f.relative(this.rootDir,s),i=n.startsWith("..")||f.isAbsolute(n),r=this.fileStack.length===0;if(r&&(this.cache.clear(),this.hasFileCycle=!1,this.fileStack=[]),i){if(r)throw new Error(`File outside rootDir: ${s}`);return new N([])}if(!F.existsSync(s)){if(r)throw new Error(`File not found: ${s}`);return new N([])}if(this.cache.has(s))return new N([]);this.cache.add(s),this.fileStack.push(s);let l=F.readFileSync(s,"utf-8");if(l.includes(`#${this.ignoreTag}`))return this.fileStack.pop(),new A([],!1);let c=l.split(/\r?\n/),d=this.parseLines(c,f.dirname(s));return this.fileStack.pop(),new A(d,r&&this.hasFileCycle)}parseLines(t,e){let s=[],n=[{indent:-1,children:s}];for(let i of t){let r=/^(\s*)- \[( |x|X)\] (.+)$/.exec(i);if(!r)continue;let l=r[1].length,c=r[2].toLowerCase()==="x",d=r[3],p={completed:c,children:[]},g=/\[\[([^\]]+)\]\]/.exec(d);if(g){let u=g[1].split("|")[0].trim(),k=u.toLowerCase().endsWith(".md")?u:`${u}.md`,h=f.resolve(e,k);if(this.isPathInsideRoot(h)&&F.existsSync(h))if(this.fileStack.includes(h))this.hasFileCycle=!0,p.children=[p];else{let m=this.buildFromFile(h);p.children=m.rootNodes||[]}}for(;n.length>0&&l<=n[n.length-1].indent;)n.pop();n[n.length-1].children.push(p),n.push({indent:l,children:p.children})}return s}};var H=L(require("fs")),$=L(require("path"));function Z(o,t,e){let s=[],n=[{indent:-1,task:void 0}];for(let i=0;i<o.length;i++){let r=/^(\s*)- \[( |x|X)\](.*)$/.exec(o[i]);if(!r)continue;let l=r[1].length,c=r[2].toLowerCase()==="x",d=r[3]||"",p={line:i,indent:l,completed:c,children:[]};if(e&&t){let a=/\[\[([^\]]+)\]\]/g,u=d.matchAll(a),k=!1,h=!0;for(let m of u){k=!0;let y=m[1].split("|")[0].trim(),b=y.toLowerCase().endsWith(".md")?y:`${y}.md`,C=$.resolve(t,b);if(H.existsSync(C)){if(e.shouldIgnoreFile(C))continue;try{let w=e.buildFromFile(C).getCounts();w.total>0&&w.total===w.completed||(h=!1)}catch(x){h=!1}}else h=!1}k&&(p.linkChildrenComplete=h)}for(;n.length>0&&l<=n[n.length-1].indent;)n.pop();let g=n[n.length-1].task;g&&(p.parent=g,g.children.push(p)),s.push(p),n.push({indent:l,task:p})}return s}function U(o,t,e,s,n="ignoretasktree"){var g;let i=o.split(/\r?\n/),r,l;e&&s&&(l=$.dirname($.isAbsolute(e)?e:$.resolve(s,e)),r=new S(s,n));let c=Z(i,l,r);if(t)for(let a of c){let u=t.get(a.line);u!==void 0&&u!==a.completed&&(a.changed=!0)}let d=c.slice().sort((a,u)=>u.indent-a.indent);for(let a of d){if(a.children.length===0&&a.linkChildrenComplete===void 0||a.changed)continue;let u=a.children.every(m=>m.completed),k=(g=a.linkChildrenComplete)!=null?g:!0,h=u&&k;a.completed!==h&&(i[a.line]=i[a.line].replace(/^(\s*- \[)( |x|X)(\])/,`$1${h?"x":" "}$3`),a.completed=h)}let p=new Map;for(let a of c)p.set(a.line,a.completed);return{content:i.join(`
`),state:p}}function I(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var ee={mySetting:"default",inlineFieldName:"COMPLETE",representation:"Complete {percentage}% ({completed}/{total})",ignoreTag:"ignoretasktree"};function V(o,t){let e=E.resolve(o,t),s=E.relative(o,e);if(s.startsWith("..")||E.isAbsolute(s)){console.warn(`Skipping invalid path outside vault: ${t}`);return}return e}var D=class extends v.Plugin{constructor(){super(...arguments);this.fileStates=new Map;this.skipModify=!1}async onload(){await this.loadSettings(),this.addCommand({id:"sample-editor-command",name:"Sample editor command",editorCallback:(e,s)=>{console.log(e.getSelection()),e.replaceSelection("Sample Editor Command")}}),this.addSettingTab(new W(this.app,this)),this.registerMarkdownPostProcessor((e,s)=>{let n=this.app.vault.adapter.basePath,i=new S(n,this.settings.ignoreTag),r=this.settings.inlineFieldName,l=this.settings.representation;e.querySelectorAll("p").forEach(c=>{let d=new RegExp(`${I(r)}:\\[\\[([^\\]]*)\\]\\]`,"g"),p=c.innerHTML;p=p.replace(d,(g,a)=>{var h;let u;if(a&&a.trim()!==""){let m=s.sourcePath?s.sourcePath.replace(/\/[^/]+$/,""):"",T=a.endsWith(".md")?a:`${a}.md`;u=m?`${m}/${T}`:T}else u=(h=s.sourcePath)!=null?h:"";let k=V(n,u);try{if(!k)throw new Error("invalid");let m=i.buildFromFile(k),T=m.getCounts(),y=m.getCompletionString(),b;if(T.total===0)b=y;else{let C=Math.round(T.completed/T.total*100);b=l.replace("{completed}",`${T.completed}`).replace("{total}",`${T.total}`).replace("{percentage}",`${C}`),y.endsWith(" \u2757")&&(b+=" \u2757")}return`<span class="completed-task-reading">${b}</span>`}catch(m){return'<span class="completed-task-reading">No tasks</span>'}}),c.innerHTML=p})}),this.registerEditorExtension(this.createLivePreviewExtension()),this.registerEvent(this.app.vault.on("modify",e=>this.handleFileModify(e)))}createLivePreviewExtension(){let e=this;class s extends M.WidgetType{constructor(l){super();this.displayText=l}toDOM(){let l=document.createElement("span");return l.className="cm-completed-task-widget",l.textContent=`[${this.displayText}]`,l}ignoreEvent(){return!1}}return M.ViewPlugin.fromClass(class{constructor(i){this.regex=new RegExp(`${I(e.settings.inlineFieldName)}:\\[\\[([^\\]]*)\\]\\]`,"g"),this.decorations=this.buildDecorations(i)}update(i){(i.docChanged||i.viewportChanged||i.selectionSet)&&(this.decorations=this.buildDecorations(i.view))}buildDecorations(i){let r=new X.RangeSetBuilder,l=i.state.field(j.editorLivePreviewField);if(!l)return r.finish();let c=l.sourcePath,d=e.app.vault.adapter.basePath,p=new S(d,e.settings.ignoreTag);for(let{from:g,to:a}of i.visibleRanges){let u=i.state.doc.sliceString(g,a),k;for(;k=this.regex.exec(u);){let h=g+k.index,m=k[0].length,T=i.state.selection.main.head;if(T>=h&&T<=h+m)continue;let y,b=k[1];if(b&&b.trim()!==""){let w=c?c.replace(/\/[^/]+$/,""):"",P=b.endsWith(".md")?b:`${b}.md`;y=w?`${w}/${P}`:P}else if(c)y=c;else{let w=e.app.workspace.getActiveFile();y=(w==null?void 0:w.path)||""}let C=V(d,y),x;try{if(!C)throw new Error("invalid");let w=p.buildFromFile(C),P=w.getCounts(),B=w.getCompletionString();if(P.total===0)x=B;else{let q=Math.round(P.completed/P.total*100);x=e.settings.representation.replace("{completed}",`${P.completed}`).replace("{total}",`${P.total}`).replace("{percentage}",`${q}`),B.endsWith(" \u2757")&&(x+=" \u2757")}}catch(w){x="No tasks"}r.add(h,h+m,M.Decoration.replace({widget:new s(x)}))}}return r.finish()}},{decorations:i=>i.decorations})}onunload(){}async loadSettings(){this.settings=Object.assign({},ee,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async handleFileModify(e){if(this.skipModify){this.skipModify=!1;return}let s=e.path,n=this.app.vault.adapter.basePath,i=new Set;await this.updateFileAndBacklinks(s,i,n)}async updateFileAndBacklinks(e,s,n){var c;if(s.has(e))return;s.add(e);let i=this.app.vault.getAbstractFileByPath(e);if(!(i instanceof v.TFile))return;try{let d=await this.app.vault.read(i),p=this.fileStates.get(e),g=U(d,p,e,n,this.settings.ignoreTag);this.fileStates.set(e,g.state),g.content!==d&&(this.skipModify=!0,await this.app.vault.modify(i,g.content))}catch(d){console.error(d)}let r=this.app.workspace.getLeavesOfType("markdown");for(let d of r)d.view instanceof v.MarkdownView&&((c=d.view.file)==null?void 0:c.path)===e&&d.view.previewMode.rerender(!0);let l=te(this.app,e);for(let d of l)await this.updateFileAndBacklinks(d,s,n)}getPageProgress(e){let s=this.app.vault.adapter.basePath,n=typeof e=="string"?e:e.path,i=V(s,n);if(!i)throw new Error(`Invalid path: ${n}`);let c=new S(s,this.settings.ignoreTag).buildFromFile(i).getCounts();return c.total===0?0:Math.round(c.completed/c.total*100)}};function te(o,t){let e=o.metadataCache.resolvedLinks,s=[];for(let[n,i]of Object.entries(e))typeof i=="object"&&i!==null&&i[t]&&s.push(n);return s}var W=class extends v.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new v.Setting(t).setName("Inline Field Name").setDesc("The name of the inline field tag (e.g., COMPLETE)").addText(e=>e.setPlaceholder("Enter inline field name").setValue(this.plugin.settings.inlineFieldName).onChange(async s=>{this.plugin.settings.inlineFieldName=s,await this.plugin.saveSettings()})),new v.Setting(t).setName("Representation Template").setDesc("Template for display using {completed}, {total}, and {percentage}").addText(e=>e.setPlaceholder("e.g., Complete {percentage}% ({completed}/{total})").setValue(this.plugin.settings.representation).onChange(async s=>{this.plugin.settings.representation=s,await this.plugin.saveSettings()})),new v.Setting(t).setName("Ignore Tag").setDesc("Tag to ignore pages (without #), e.g., ignoretasktree").addText(e=>e.setPlaceholder("Enter ignore tag").setValue(this.plugin.settings.ignoreTag).onChange(async s=>{this.plugin.settings.ignoreTag=s,await this.plugin.saveSettings()}))}};
