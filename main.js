/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var K=Object.create;var W=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var Z=Object.getPrototypeOf,ee=Object.prototype.hasOwnProperty;var te=(r,t)=>{for(var e in t)W(r,e,{get:t[e],enumerable:!0})},X=(r,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Y(t))!ee.call(r,n)&&n!==e&&W(r,n,{get:()=>t[n],enumerable:!(s=Q(t,n))||s.enumerable});return r};var I=(r,t,e)=>(e=r!=null?K(Z(r)):{},X(t||!r||!r.__esModule?W(e,"default",{value:r,enumerable:!0}):e,r)),se=r=>X(W({},"__esModule",{value:!0}),r);var re={};te(re,{default:()=>V});module.exports=se(re);var k=require("obsidian"),D=I(require("path")),z=require("obsidian"),G=require("@codemirror/state"),R=require("@codemirror/view");var M=I(require("fs")),m=I(require("path"));var $=class{constructor(t){this.hasCycle=!1;this.rootNodes=t}processNode(t,e=new Set){if(e.has(t))return this.hasCycle=!0,{total:0,completed:0};if(e.add(t),!t.children||t.children.length===0){let s={total:1,completed:t.completed?1:0};return e.delete(t),s}else{let s=0,n=0;for(let i of t.children){let o=this.processNode(i,e);s+=o.total,n+=o.completed}return e.delete(t),{total:s,completed:n}}}getCounts(){this.hasCycle=!1;let t=0,e=0;for(let s of this.rootNodes){let n=this.processNode(s);t+=n.total,e+=n.completed}return{total:t,completed:e}}getCompletionString(){let t=this.getCounts(),e;return t.total===0?e="No tasks":e=`Complete ${Math.round(t.completed/t.total*100)}% (${t.completed}/${t.total})`,(this.hasMalformed()||this.hasCycle)&&(e+=" \u2757"),e}addSubtask(t,e){let s=this.findNode(t,this.rootNodes);if(!s)throw new Error("Parent task not found");s.children.push(e)}findNode(t,e){for(let s of e){if(s===t)return s;let n=this.findNode(t,s.children);if(n)return n}return null}hasMalformed(){let t=e=>{if(e.children&&e.children.length>0){let s=this.processNode(e);if(e.completed&&s.completed<s.total||!e.completed&&s.completed===s.total)return!0;for(let n of e.children)if(t(n))return!0}return!1};return this.rootNodes.some(t)}};var B=class extends ${constructor(e,s){super(e);this.fileHasCycle=s}getCounts(){return this.fileHasCycle?{total:0,completed:0}:super.getCounts()}getCompletionString(){let e=super.getCompletionString();return this.fileHasCycle&&!e.endsWith(" \u2757")?e+" \u2757":e}},E=class{constructor(t,e="ignoretasktree"){this.cache=new Set;this.hasFileCycle=!1;this.fileStack=[];this.rootDir=m.resolve(t||process.cwd()),this.ignoreTag=e}isPathInsideRoot(t){let e=m.relative(this.rootDir,t);return!e.startsWith("..")&&!m.isAbsolute(e)}shouldIgnoreFile(t){let e=m.isAbsolute(t)?t:m.resolve(this.rootDir,t);return!this.isPathInsideRoot(e)||!M.existsSync(e)?!1:M.readFileSync(e,"utf-8").includes(`#${this.ignoreTag}`)}buildFromFile(t){let e=m.isAbsolute(t)?t:m.resolve(this.rootDir,t),s=m.normalize(e),n=m.relative(this.rootDir,s),i=n.startsWith("..")||m.isAbsolute(n),o=this.fileStack.length===0;if(o&&(this.cache.clear(),this.hasFileCycle=!1,this.fileStack=[]),i){if(o)throw new Error(`File outside rootDir: ${s}`);return new $([])}if(!M.existsSync(s)){if(o)throw new Error(`File not found: ${s}`);return new $([])}if(this.cache.has(s))return new $([]);this.cache.add(s),this.fileStack.push(s);let c=M.readFileSync(s,"utf-8");if(c.includes(`#${this.ignoreTag}`))return this.fileStack.pop(),new B([],!1);let h=c.split(/\r?\n/),a=this.parseLines(h,m.dirname(s));return this.fileStack.pop(),new B(a,o&&this.hasFileCycle)}parseLines(t,e){let s=[],n=[{indent:-1,children:s}];for(let i of t){let o=/^(\s*)- \[( |x|X)\] (.+)$/.exec(i);if(!o)continue;let c=o[1].length,h=o[2].toLowerCase()==="x",a=o[3],d={completed:h,children:[]},f=/\[\[([^\]]+)\]\]/.exec(a);if(f){let u=f[1].split("|")[0].trim(),P=u.toLowerCase().endsWith(".md")?u:`${u}.md`,p=m.resolve(e,P);if(this.isPathInsideRoot(p)&&M.existsSync(p))if(this.fileStack.includes(p))this.hasFileCycle=!0,d.children=[d];else{let g=this.buildFromFile(p);d.children=g.rootNodes||[]}}for(;n.length>0&&c<=n[n.length-1].indent;)n.pop();n[n.length-1].children.push(d),n.push({indent:c,children:d.children})}return s}};var _=I(require("fs")),L=I(require("path"));function ne(r,t,e){let s=[],n=[{indent:-1,task:void 0}];for(let i=0;i<r.length;i++){let o=/^(\s*)- \[( |x|X)\](.*)$/.exec(r[i]);if(!o)continue;let c=o[1].length,h=o[2].toLowerCase()==="x",a=o[3]||"",d={line:i,indent:c,completed:h,children:[]};if(e&&t){let l=/\[\[([^\]]+)\]\]/g,u=a.matchAll(l),P=!1,p=!0;for(let g of u){console.log(`Found link: ${g[1]}`),P=!0;let C=g[1].split("|")[0].trim(),x=C.toLowerCase().endsWith(".md")?C:`${C}.md`,v=L.resolve(t,x);if(_.existsSync(v)){if(e.shouldIgnoreFile(v))continue;try{let T=e.buildFromFile(v).getCounts();T.total!=0&&(T.total>0&&T.total===T.completed||(p=!1))}catch(S){p=!1}}}P&&(d.linkChildrenComplete=p)}for(;n.length>0&&c<=n[n.length-1].indent;)n.pop();let f=n[n.length-1].task;f&&(d.parent=f,f.children.push(d)),s.push(d),n.push({indent:c,task:d})}return s}function q(r,t,e,s,n="ignoretasktree"){var f;let i=r.split(/\r?\n/),o,c;e&&s&&(c=L.dirname(L.isAbsolute(e)?e:L.resolve(s,e)),o=new E(s,n));let h=ne(i,c,o);if(t)for(let l of h){let u=t.get(l.line);u!==void 0&&u!==l.completed&&(l.changed=!0)}let a=h.slice().sort((l,u)=>u.indent-l.indent);for(let l of a){if(l.children.length===0&&l.linkChildrenComplete===void 0||l.changed)continue;let u=l.children.every(g=>g.completed),P=(f=l.linkChildrenComplete)!=null?f:!0,p=u&&P;l.completed!==p&&(i[l.line]=i[l.line].replace(/^(\s*- \[)( |x|X)(\])/,`$1${p?"x":" "}$3`),l.completed=p)}let d=new Map;for(let l of h)d.set(l.line,l.completed);return{content:i.join(`
`),state:d}}function O(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var ie={mySetting:"default",inlineFieldName:"COMPLETE",representation:"Complete {percentage}% ({completed}/{total})",ignoreTag:"ignoretasktree"};function U(r,t){let e=D.resolve(r,t),s=D.relative(r,e);if(s.startsWith("..")||D.isAbsolute(s)){console.warn(`Skipping invalid path outside vault: ${t}`);return}return e}var V=class extends k.Plugin{constructor(){super(...arguments);this.fileStates=new Map;this.skipModify=!1}async onload(){await this.loadSettings(),this.addCommand({id:"sample-editor",name:"Sample editor command",editorCallback:(e,s)=>{console.log(e.getSelection()),e.replaceSelection("Sample Editor Command")}}),this.addSettingTab(new j(this.app,this)),this.registerMarkdownPostProcessor((e,s)=>{let n="",i=this.app.vault.adapter;i instanceof k.FileSystemAdapter&&(n=i.getBasePath());let o=new E(n,this.settings.ignoreTag),c=this.settings.inlineFieldName,h=this.settings.representation;e.querySelectorAll("p").forEach(a=>{var P;let d=new RegExp(`${O(c)}:\\[\\[([^\\]]*)\\]\\]`,"g"),f=document.createTreeWalker(a,NodeFilter.SHOW_TEXT),l=[],u;for(;u=f.nextNode();){let p=u.nodeValue||"";d.lastIndex=0;let g,y=0,C=document.createDocumentFragment();for(;g=d.exec(p);){let v=p.slice(y,g.index);v&&C.append(v);let S=g[1],T;if(S&&S.trim()!==""){let N=s.sourcePath?s.sourcePath.replace(/\/[^/]+$/,""):"",F=S.endsWith(".md")?S:`${S}.md`;T=N?`${N}/${F}`:F}else T=(P=s.sourcePath)!=null?P:"";let w=U(n,T),b;try{if(!w)throw new Error("invalid");let N=o.buildFromFile(w),F=N.getCounts(),H=N.getCompletionString();if(F.total===0)b=H;else{let J=Math.round(F.completed/F.total*100);b=h.replace("{completed}",`${F.completed}`).replace("{total}",`${F.total}`).replace("{percentage}",`${J}`),H.endsWith(" \u2757")&&(b+=" \u2757")}}catch(N){b="No tasks"}let A=document.createElement("span");A.addClass("completed-task-reading"),A.setText(b),C.append(A),y=g.index+g[0].length}if(y===0)continue;let x=p.slice(y);x&&C.append(x),l.push({node:u,frag:C})}for(let{node:p,frag:g}of l)p.replaceWith(g)})}),this.registerEditorExtension(this.createLivePreviewExtension()),this.registerEvent(this.app.vault.on("modify",e=>this.handleFileModify(e)))}createLivePreviewExtension(){let e=this;class s extends R.WidgetType{constructor(c){super();this.displayText=c}toDOM(){let c=document.createElement("span");return c.className="cm-completed-task-widget",c.textContent=`[${this.displayText}]`,c}ignoreEvent(){return!1}}return R.ViewPlugin.fromClass(class{constructor(i){this.regex=new RegExp(`${O(e.settings.inlineFieldName)}:\\[\\[([^\\]]*)\\]\\]`,"g"),this.decorations=this.buildDecorations(i)}update(i){(i.docChanged||i.viewportChanged||i.selectionSet)&&(this.decorations=this.buildDecorations(i.view))}buildDecorations(i){let o=new G.RangeSetBuilder,c=i.state.field(z.editorLivePreviewField);if(!c)return o.finish();let h=c.sourcePath,a="",d=e.app.vault.adapter;d instanceof k.FileSystemAdapter&&(a=d.getBasePath());let f=new E(a,e.settings.ignoreTag);for(let{from:l,to:u}of i.visibleRanges){let P=i.state.doc.sliceString(l,u),p;for(;p=this.regex.exec(P);){let g=l+p.index,y=p[0].length,C=i.state.selection.main.head;if(C>=g&&C<=g+y)continue;let x,v=p[1];if(v&&v.trim()!==""){let w=h?h.replace(/\/[^/]+$/,""):"",b=v.endsWith(".md")?v:`${v}.md`;x=w?`${w}/${b}`:b}else if(h)x=h;else{let w=e.app.workspace.getActiveFile();x=(w==null?void 0:w.path)||""}let S=U(a,x),T;try{if(!S)throw new Error("invalid");let w=f.buildFromFile(S),b=w.getCounts(),A=w.getCompletionString();if(b.total===0)T=A;else{let N=Math.round(b.completed/b.total*100);T=e.settings.representation.replace("{completed}",`${b.completed}`).replace("{total}",`${b.total}`).replace("{percentage}",`${N}`),A.endsWith(" \u2757")&&(T+=" \u2757")}}catch(w){T="No tasks"}o.add(g,g+y,R.Decoration.replace({widget:new s(T)}))}}return o.finish()}},{decorations:i=>i.decorations})}onunload(){}async loadSettings(){this.settings=Object.assign({},ie,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async handleFileModify(e){if(this.skipModify){this.skipModify=!1;return}let s=e.path,n="",i=this.app.vault.adapter;i instanceof k.FileSystemAdapter&&(n=i.getBasePath());let o=new Set;await this.updateFileAndBacklinks(s,o,n)}async updateFileAndBacklinks(e,s,n){var h;if(s.has(e))return;s.add(e);let i=this.app.vault.getAbstractFileByPath(e);if(!(i instanceof k.TFile))return;try{let a=await this.app.vault.read(i),d=this.fileStates.get(e),f=q(a,d,e,n,this.settings.ignoreTag);this.fileStates.set(e,f.state),f.content!==a&&(this.skipModify=!0,await this.app.vault.modify(i,f.content))}catch(a){console.error(a)}let o=this.app.workspace.getLeavesOfType("markdown");for(let a of o)a.view instanceof k.MarkdownView&&((h=a.view.file)==null?void 0:h.path)===e&&a.view.previewMode.rerender(!0);let c=oe(this.app,e);for(let a of c)await this.updateFileAndBacklinks(a,s,n)}getPageProgress(e){let s="",n=this.app.vault.adapter;n instanceof k.FileSystemAdapter&&(s=n.getBasePath());let i=typeof e=="string"?e:e.path,o=U(s,i);if(!o)throw new Error(`Invalid path: ${i}`);let a=new E(s,this.settings.ignoreTag).buildFromFile(o).getCounts();return a.total===0?0:Math.round(a.completed/a.total*100)}};function oe(r,t){let e=r.metadataCache.resolvedLinks,s=[];for(let[n,i]of Object.entries(e))typeof i=="object"&&i!==null&&i[t]&&s.push(n);return s}var j=class extends k.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new k.Setting(t).setName("Inline Field Name").setDesc("The name of the inline field tag (e.g., COMPLETE)").addText(e=>e.setPlaceholder("Enter inline field name").setValue(this.plugin.settings.inlineFieldName).onChange(async s=>{this.plugin.settings.inlineFieldName=s,await this.plugin.saveSettings()})),new k.Setting(t).setName("Representation Template").setDesc("Template for display using {completed}, {total}, and {percentage}").addText(e=>e.setPlaceholder("e.g., Complete {percentage}% ({completed}/{total})").setValue(this.plugin.settings.representation).onChange(async s=>{this.plugin.settings.representation=s,await this.plugin.saveSettings()})),new k.Setting(t).setName("Ignore Tag").setDesc("Tag to ignore pages (without #), e.g., ignoretasktree").addText(e=>e.setPlaceholder("Enter ignore tag").setValue(this.plugin.settings.ignoreTag).onChange(async s=>{this.plugin.settings.ignoreTag=s,await this.plugin.saveSettings()}))}};
