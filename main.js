/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var Y=Object.create;var O=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var ee=Object.getOwnPropertyNames;var te=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var ne=(l,s)=>{for(var e in s)O(l,e,{get:s[e],enumerable:!0})},q=(l,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of ee(s))!se.call(l,n)&&n!==e&&O(l,n,{get:()=>s[n],enumerable:!(t=Z(s,n))||t.enumerable});return l};var B=(l,s,e)=>(e=l!=null?Y(te(l)):{},q(s||!l||!l.__esModule?O(e,"default",{value:l,enumerable:!0}):e,l)),ie=l=>q(O({},"__esModule",{value:!0}),l);var re={};ne(re,{default:()=>j});module.exports=ie(re);var m=require("obsidian"),F=B(require("path")),J=require("obsidian"),K=require("@codemirror/state"),R=require("@codemirror/view");var A=B(require("fs")),k=B(require("path"));var M=class{constructor(s){this.hasCycle=!1;this.rootNodes=s}processNode(s,e=new Set){if(e.has(s))return this.hasCycle=!0,{total:0,completed:0};if(e.add(s),!s.children||s.children.length===0){let t={total:1,completed:s.completed?1:0};return e.delete(s),t}else{let t=0,n=0;for(let i of s.children){let o=this.processNode(i,e);t+=o.total,n+=o.completed}return e.delete(s),{total:t,completed:n}}}getCounts(){this.hasCycle=!1;let s=0,e=0;for(let t of this.rootNodes){let n=this.processNode(t);s+=n.total,e+=n.completed}return{total:s,completed:e}}getCompletionString(){let s=this.getCounts(),e;return s.total===0?e="No tasks":e=`Complete ${Math.round(s.completed/s.total*100)}% (${s.completed}/${s.total})`,(this.hasMalformed()||this.hasCycle)&&(e+=" \u2757"),e}addSubtask(s,e){let t=this.findNode(s,this.rootNodes);if(!t)throw new Error("Parent task not found");t.children.push(e)}findNode(s,e){for(let t of e){if(t===s)return t;let n=this.findNode(s,t.children);if(n)return n}return null}hasMalformed(){let s=e=>{if(e.children&&e.children.length>0){let t=this.processNode(e);if(e.completed&&t.completed<t.total||!e.completed&&t.completed===t.total)return!0;for(let n of e.children)if(s(n))return!0}return!1};return this.rootNodes.some(s)}};var U=class extends M{constructor(e,t){super(e);this.fileHasCycle=t}getCounts(){return this.fileHasCycle?{total:0,completed:0}:super.getCounts()}getCompletionString(){let e=super.getCompletionString();return this.fileHasCycle&&!e.endsWith(" \u2757")?e+" \u2757":e}},C=class{constructor(s,e="ignoretasktree"){this.cache=new Set;this.hasFileCycle=!1;this.fileStack=[];this.rootDir=k.resolve(s||process.cwd()),this.ignoreTag=e}isPathInsideRoot(s){let e=k.relative(this.rootDir,s);return!e.startsWith("..")&&!k.isAbsolute(e)}shouldIgnoreFile(s){let e=k.isAbsolute(s)?s:k.resolve(this.rootDir,s);return!this.isPathInsideRoot(e)||!A.existsSync(e)?!1:A.readFileSync(e,"utf-8").includes(`#${this.ignoreTag}`)}buildFromFile(s){let e=k.isAbsolute(s)?s:k.resolve(this.rootDir,s),t=k.normalize(e),n=k.relative(this.rootDir,t),i=n.startsWith("..")||k.isAbsolute(n),o=this.fileStack.length===0;if(o&&(this.cache.clear(),this.hasFileCycle=!1,this.fileStack=[]),i){if(o)throw new Error(`File outside rootDir: ${t}`);return new M([])}if(!A.existsSync(t)){if(o)throw new Error(`File not found: ${t}`);return new M([])}if(this.cache.has(t))return new M([]);this.cache.add(t),this.fileStack.push(t);let c=A.readFileSync(t,"utf-8");if(c.includes(`#${this.ignoreTag}`))return this.fileStack.pop(),new U([],!1);let p=c.split(/\r?\n/),r=this.parseLines(p,k.dirname(t));return this.fileStack.pop(),new U(r,o&&this.hasFileCycle)}parseLines(s,e){let t=[],n=[{indent:-1,children:t}];for(let i of s){let o=/^(\s*)- \[( |x|X)\] (.+)$/.exec(i);if(!o)continue;let c=o[1].length,p=o[2].toLowerCase()==="x",r=o[3],d={completed:p,children:[]},f=/\[\[([^\]]+)\]\]/.exec(r);if(f){let a=f[1].split("|")[0].trim(),g=a.toLowerCase().endsWith(".md")?a:`${a}.md`,h=k.resolve(e,g);if(this.isPathInsideRoot(h)&&A.existsSync(h))if(this.fileStack.includes(h))this.hasFileCycle=!0,d.children=[d];else{let u=this.buildFromFile(h);d.children=u.rootNodes||[]}}for(;n.length>0&&c<=n[n.length-1].indent;)n.pop();n[n.length-1].children.push(d),n.push({indent:c,children:d.children})}return t}};var z=B(require("fs")),D=B(require("path"));function W(l,s,e){let t=[],n=[{indent:-1,task:void 0}];for(let i=0;i<l.length;i++){let o=/^(\s*)- \[( |x|X)\](.*)$/.exec(l[i]);if(!o)continue;let c=o[1].length,p=o[2].toLowerCase()==="x",r=o[3]||"",d={line:i,indent:c,completed:p,children:[]};if(e&&s){let T=/\[\[([^\]]+)\]\]/g,a=r.matchAll(T),g=!1,h=!0;for(let u of a){console.log(`Found link: ${u[1]}`),g=!0;let S=u[1].split("|")[0].trim(),x=S.toLowerCase().endsWith(".md")?S:`${S}.md`,b=D.resolve(s,x);if(z.existsSync(b)){if(e.shouldIgnoreFile(b))continue;try{let w=e.buildFromFile(b).getCounts();w.total!=0&&(w.total>0&&w.total===w.completed||(h=!1))}catch(E){h=!1}}}g&&(d.linkChildrenComplete=h)}for(;n.length>0&&c<=n[n.length-1].indent;)n.pop();let f=n[n.length-1].task;f&&(d.parent=f,f.children.push(d)),t.push(d),n.push({indent:c,task:d})}return t}function G(l,s,e,t,n="ignoretasktree",i=!0){var T;if(!i){let a=l.split(/\r?\n/),g=W(a),h=new Map;for(let u of g)h.set(u.line,u.completed);return{content:l,state:h}}let o=l.split(/\r?\n/),c,p;e&&t&&(p=D.dirname(D.isAbsolute(e)?e:D.resolve(t,e)),c=new C(t,n));let r=W(o,p,c);if(s)for(let a of r){let g=s.get(a.line);g!==void 0&&g!==a.completed&&(a.changed=!0)}let d=r.slice().sort((a,g)=>g.indent-a.indent);for(let a of d){if(a.children.length===0&&a.linkChildrenComplete===void 0||a.changed)continue;let g=a.children.every(P=>P.completed),h=(T=a.linkChildrenComplete)!=null?T:!0,u=g&&h;a.completed!==u&&(o[a.line]=o[a.line].replace(/^(\s*- \[)( |x|X)(\])/,`$1${u?"x":" "}$3`),a.completed=u)}let f=new Map;for(let a of r)f.set(a.line,a.completed);return{content:o.join(`
`),state:f}}function H(l){return l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var oe={mySetting:"default",inlineFieldName:"COMPLETE",representation:"Complete {percentage}% ({completed}/{total})",ignoreTag:"ignoretasktree",autoPropagateTaskStates:!0};function V(l,s){let e=F.resolve(l,s),t=F.relative(l,e);if(t.startsWith("..")||F.isAbsolute(t)){console.warn(`Skipping invalid path outside vault: ${s}`);return}return e}var j=class extends m.Plugin{constructor(){super(...arguments);this.fileStates=new Map;this.skipModify=!1;this.pageTasksCache=null;this.lastOpenedFilePath=null}async onload(){await this.loadSettings(),this.addSettingTab(new X(this.app,this)),this.registerMarkdownPostProcessor((t,n)=>{let i="",o=this.app.vault.adapter;o instanceof m.FileSystemAdapter&&(i=o.getBasePath());let c=new C(i,this.settings.ignoreTag),p=this.settings.inlineFieldName,r=this.settings.representation;t.querySelectorAll("p").forEach(d=>{var h;let f=new RegExp(`${H(p)}:\\[\\[([^\\]]*)\\]\\]`,"g"),T=document.createTreeWalker(d,NodeFilter.SHOW_TEXT),a=[],g;for(;g=T.nextNode();){let u=g.nodeValue||"";f.lastIndex=0;let P,S=0,x=document.createDocumentFragment();for(;P=f.exec(u);){let E=u.slice(S,P.index);E&&x.append(E);let w=P[1],v;if(w&&w.trim()!==""){let L=n.sourcePath?n.sourcePath.replace(/\/[^/]+$/,""):"",$=w.endsWith(".md")?w:`${w}.md`;v=L?`${L}/${$}`:$}else v=(h=n.sourcePath)!=null?h:"";let y=V(i,v),N;try{if(!y)throw new Error("invalid");let L=c.buildFromFile(y),$=L.getCounts(),_=L.getCompletionString();if($.total===0)N=_;else{let Q=Math.round($.completed/$.total*100);N=r.replace("{completed}",`${$.completed}`).replace("{total}",`${$.total}`).replace("{percentage}",`${Q}`),_.endsWith(" \u2757")&&(N+=" \u2757")}}catch(L){N="No tasks"}let I=document.createElement("span");I.addClass("completed-task-reading"),I.setText(N),x.append(I),S=P.index+P[0].length}if(S===0)continue;let b=u.slice(S);b&&x.append(b),a.push({node:g,frag:x})}for(let{node:u,frag:P}of a)u.replaceWith(P)})}),this.registerEditorExtension(this.createLivePreviewExtension()),this.registerEvent(this.app.vault.on("modify",t=>this.handleFileModify(t))),this.registerEvent(this.app.workspace.on("file-open",t=>this.handleFileOpen(t))),this.registerEvent(this.app.vault.on("delete",t=>this.handleFileDelete(t)));let e=this.app.workspace.getActiveFile();e&&await this.handleFileOpen(e)}handleFileDelete(e){this.pageTasksCache=null}async handleFileOpen(e){if(!e)return;let t="",n=this.app.vault.adapter;n instanceof m.FileSystemAdapter&&(t=n.getBasePath());let i=V(t,e.path);if(i){try{let o=await this.app.vault.read(e);if(o.match(new RegExp(`#${this.settings.ignoreTag}(s|$)`)))return;let c=o.split(/\r?\n/),p=F.dirname(i),r=new C(t,this.settings.ignoreTag),d=W(c,p,r);if(!d||d.length===0)return;this.pageTasksCache=d}catch(o){console.error("[ProgressTracker] Failed to parse tasks for file",e.path,o)}this.lastOpenedFilePath=e?e.path:null}}createLivePreviewExtension(){let e=this;class t extends R.WidgetType{constructor(c){super();this.displayText=c}toDOM(){let c=document.createElement("span");return c.className="cm-completed-task-widget",c.textContent=`[${this.displayText}]`,c}ignoreEvent(){return!1}}return R.ViewPlugin.fromClass(class{constructor(i){this.regex=new RegExp(`${H(e.settings.inlineFieldName)}:\\[\\[([^\\]]*)\\]\\]`,"g"),this.decorations=this.buildDecorations(i)}update(i){(i.docChanged||i.viewportChanged||i.selectionSet)&&(this.decorations=this.buildDecorations(i.view))}buildDecorations(i){let o=new K.RangeSetBuilder,c=i.state.field(J.editorLivePreviewField);if(!c)return o.finish();let p=c.sourcePath,r="",d=e.app.vault.adapter;d instanceof m.FileSystemAdapter&&(r=d.getBasePath());let f=new C(r,e.settings.ignoreTag);for(let{from:T,to:a}of i.visibleRanges){let g=i.state.doc.sliceString(T,a),h;for(;h=this.regex.exec(g);){let u=T+h.index,P=h[0].length,S=i.state.selection.main.head;if(S>=u&&S<=u+P)continue;let x,b=h[1];if(b&&b.trim()!==""){let v=p?p.replace(/\/[^/]+$/,""):"",y=b.endsWith(".md")?b:`${b}.md`;x=v?`${v}/${y}`:y}else if(p)x=p;else{let v=e.app.workspace.getActiveFile();x=(v==null?void 0:v.path)||""}let E=V(r,x),w;try{if(!E)throw new Error("invalid");let v=f.buildFromFile(E),y=v.getCounts(),N=v.getCompletionString();if(y.total===0)w=N;else{let I=Math.round(y.completed/y.total*100);w=e.settings.representation.replace("{completed}",`${y.completed}`).replace("{total}",`${y.total}`).replace("{percentage}",`${I}`),N.endsWith(" \u2757")&&(w+=" \u2757")}}catch(v){w="No tasks"}o.add(u,u+P,R.Decoration.replace({widget:new t(w)}))}}return o.finish()}},{decorations:i=>i.decorations})}onunload(){}async loadSettings(){this.settings=Object.assign({},oe,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async handleFileModify(e){var c;if(this.skipModify){this.skipModify=!1;return}let t=e.path,n="",i=this.app.vault.adapter;i instanceof m.FileSystemAdapter&&(n=i.getBasePath());try{let p=await this.app.vault.read(e);if(p.match(new RegExp(`#${this.settings.ignoreTag}(s|$)`)))return;let r=p.split(/\r?\n/),d=F.dirname((c=V(n,t))!=null?c:""),f=new C(n,this.settings.ignoreTag),T=W(r,d,f);if(!T||T.length===0)return;let a=this.pageTasksCache;if(this.lastOpenedFilePath===t&&a&&a.length===T.length&&a.every((g,h)=>g.line===T[h].line&&g.completed===T[h].completed))return}catch(p){console.error("[ProgressTracker] Error comparing cache for file",t,p)}let o=new Set;await this.updateFileAndBacklinks(t,o,n)}async updateFileAndBacklinks(e,t,n){var p;if(t.has(e))return;t.add(e);let i=this.app.vault.getAbstractFileByPath(e);if(!(i instanceof m.TFile))return;try{let r=await this.app.vault.read(i),d=this.fileStates.get(e),f=G(r,d,e,n,this.settings.ignoreTag,this.settings.autoPropagateTaskStates);this.fileStates.set(e,f.state),f.content!==r&&(this.skipModify=!0,await this.app.vault.modify(i,f.content))}catch(r){console.error(r)}let o=this.app.workspace.getLeavesOfType("markdown");for(let r of o)r.view instanceof m.MarkdownView&&((p=r.view.file)==null?void 0:p.path)===e&&r.view.previewMode.rerender(!0);let c=ae(this.app,e);for(let r of c)await this.updateFileAndBacklinks(r,t,n)}getPageProgress(e){let t="",n=this.app.vault.adapter;n instanceof m.FileSystemAdapter&&(t=n.getBasePath());let i=typeof e=="string"?e:e.path,o=V(t,i);if(!o)throw new Error(`Invalid path: ${i}`);let r=new C(t,this.settings.ignoreTag).buildFromFile(o).getCounts();return r.total===0?0:Math.round(r.completed/r.total*100)}};function ae(l,s){let e=l.metadataCache.resolvedLinks,t=[];for(let[n,i]of Object.entries(e))typeof i=="object"&&i!==null&&i[s]&&t.push(n);return t}var X=class extends m.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;s.empty(),new m.Setting(s).setName("Inline Field Name").setDesc("The name of the inline field tag (e.g., COMPLETE)").addText(e=>e.setPlaceholder("Enter inline field name").setValue(this.plugin.settings.inlineFieldName).onChange(async t=>{this.plugin.settings.inlineFieldName=t,await this.plugin.saveSettings()})),new m.Setting(s).setName("Representation Template").setDesc("Template for display using {completed}, {total}, and {percentage}").addText(e=>e.setPlaceholder("e.g., Complete {percentage}% ({completed}/{total})").setValue(this.plugin.settings.representation).onChange(async t=>{this.plugin.settings.representation=t,await this.plugin.saveSettings()})),new m.Setting(s).setName("Ignore Tag").setDesc("Tag to ignore pages (without #), e.g., ignoretasktree").addText(e=>e.setPlaceholder("Enter ignore tag").setValue(this.plugin.settings.ignoreTag).onChange(async t=>{this.plugin.settings.ignoreTag=t,await this.plugin.saveSettings()})),new m.Setting(s).setName("Auto Propagate Task States").setDesc("Automatically check/uncheck parent tasks when all children change state").addToggle(e=>e.setValue(this.plugin.settings.autoPropagateTaskStates).onChange(async t=>{this.plugin.settings.autoPropagateTaskStates=t,await this.plugin.saveSettings()}))}};
